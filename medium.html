<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Numerals</title>

    <!-- Fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- CSS -->
    <link rel="stylesheet" href="./css/style.css">

    <!-- favicon -->
    <link rel="icon" type="image/x-icon" href="./img/favicon.png">
</head>
<body>

<div class="main">
    <h1>Numerals - Medium</h1>

    <nav>
        <a href="index.html">Easy</a> |
        <a class="active">Medium</a> |
        <a href="hard.html">Hard</a>
    </nav>

    <div class="board">
        <div class="row">
            <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
        </div>
        <div class="row">
            <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
        </div>
        <div class="row">
            <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
        </div>
        <div class="row">
            <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
        </div>
        <div class="row">
            <div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div><div class="cell"></div>
        </div>
    </div>

    <form onsubmit="processInput(); return false;" autocomplete="off">
        <input type="text" id="userInputField" maxlength="5" placeholder="Give it a try!">

        <div>
            <button type="button" onclick="toggleTheme()">
                <i class="fa-solid fa-moon"></i>
            </button>
            <button type="button" onclick="rules()">
                <i class="fa-solid fa-file-lines"></i> How to play
            </button>
            <button type="submit" id="submitguess">
                <i class="fa-solid fa-share"></i> Submit
            </button>
        </div>
    </form>

    <div id="output"></div>
</div>

<script>
/* =========================
   CONFIG
========================= */
const DIFFICULTY = "medium";
const DIGITS = 5;
const maxAttempts = 5;


/* =========================
   SHOW RULES
========================= */
function rules() {
    alert(`
[EN]
NUMERALS RULES

â€¢ Guess the daily ${DIGITS}-digit number
â€¢ Limited attempts by difficulty
â€¢ Same number for all players (per difficulty)
â€¢ Changes every day at 00:00

ðŸŸ© Correct
ðŸŸ¨ Present
â¬œ Absent

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[PT-BR]
â€¢ Descubra o nÃºmero diÃ¡rio de ${DIGITS} dÃ­gitos
â€¢ Tentativas variam conforme a dificuldade
â€¢ Mesmo nÃºmero para todos (por dificuldade)
â€¢ O nÃºmero muda diariamente Ã  meia-noite

ðŸŸ© Correto
ðŸŸ¨ Presente
â¬œ NÃ£o existe
`);
}

/* =========================
   DAILY SEED SYSTEM
========================= */
const START_DATE = new Date("2024-01-01");

function daysSinceStart() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    return Math.floor((today - START_DATE) / 86400000);
}

function seededRandom(seed) {
    let hash = 0;
    for (let i = 0; i < seed.length; i++) {
        hash = seed.charCodeAt(i) + ((hash << 5) - hash);
    }
    return function () {
        hash = (hash * 9301 + 49297) % 233280;
        return hash / 233280;
    };
}

function getDailyNumber() {
    const day = daysSinceStart();
    const seed = `${day}-${DIFFICULTY}`;
    const rand = seededRandom(seed);

    const min = Math.pow(10, DIGITS - 1);
    const max = Math.pow(10, DIGITS) - 1;

    return Math.floor(rand() * (max - min + 1) + min).toString();
}

const todayKey = `${new Date().toISOString().slice(0,10)}-${DIFFICULTY}`;
const randomNumber = getDailyNumber();

/* =========================
   GAME STATE
========================= */
let currentAttempt = 0;
let gameOver = false;

const rows = document.querySelectorAll(".row");
const output = document.getElementById("output");
const input = document.getElementById("userInputField");

/* =========================
   RESTORE DAILY STATE
========================= */
const savedGame = JSON.parse(localStorage.getItem(todayKey));

if (savedGame) {
    currentAttempt = savedGame.currentAttempt;
    gameOver = savedGame.gameOver;

    savedGame.board.forEach((row, r) => {
        const cells = rows[r].querySelectorAll(".cell");
        row.forEach((cell, c) => {
            cells[c].textContent = cell.value;
            if (cell.state) cells[c].classList.add(cell.state);
        });
    });

    if (gameOver) showCountdown();
}

/* =========================
   WORDLE LOGIC
========================= */
function evaluateGuess(guess, secret) {
    const result = Array(DIGITS).fill(null);
    const used = Array(DIGITS).fill(false);

    // Green
    for (let i = 0; i < DIGITS; i++) {
        if (guess[i] === secret[i]) {
            result[i] = "correct";
            used[i] = true;
        }
    }

    // Yellow
    for (let i = 0; i < DIGITS; i++) {
        if (result[i]) continue;
        for (let j = 0; j < DIGITS; j++) {
            if (!used[j] && guess[i] === secret[j]) {
                result[i] = "present";
                used[j] = true;
                break;
            }
        }
    }

    return result;
}

/* =========================
   INPUT HANDLER
========================= */
function processInput() {
    if (gameOver) return;

    const value = input.value.trim();

    if (!new RegExp(`^\\d{${DIGITS}}$`).test(value)) {
        output.textContent = `Enter exactly ${DIGITS} digits.`;
        return;
    }

    const guess = value.split("");
    const secret = randomNumber.split("");
    const evaluation = evaluateGuess(guess, secret);
    const cells = rows[currentAttempt].querySelectorAll(".cell");

    for (let i = 0; i < DIGITS; i++) {
        cells[i].textContent = guess[i];
        if (evaluation[i]) cells[i].classList.add(evaluation[i]);
    }

    currentAttempt++;
    input.value = "";

    saveGameState();

    if (value === randomNumber) {
        output.textContent = "ðŸŽ‰ You solved todayâ€™s challenge!";
        gameOver = true;
        endGame();
        return;
    }

    if (currentAttempt === maxAttempts) {
        output.textContent = `âŒ Game Over! The number was ${randomNumber}`;
        gameOver = true;
        endGame();
    }
}

/* =========================
   SAVE STATE
========================= */
function saveGameState() {
    const board = Array.from(rows).map(row =>
        Array.from(row.querySelectorAll(".cell")).map(cell => ({
            value: cell.textContent,
            state: [...cell.classList].find(c => c === "correct" || c === "present")
        }))
    );

    localStorage.setItem(todayKey, JSON.stringify({
        currentAttempt,
        gameOver,
        board
    }));
}

/* =========================
   COUNTDOWN TIMER
========================= */
function endGame() {
    saveGameState();
    showCountdown();
}

function showCountdown() {
    let timer = document.getElementById("countdown");
    if (!timer) {
        timer = document.createElement("div");
        timer.id = "countdown";
        output.appendChild(timer);
    }

    setInterval(() => {
        const now = new Date();
        const tomorrow = new Date();
        tomorrow.setHours(24, 0, 0, 0);

        const diff = tomorrow - now;
        const h = String(Math.floor(diff / 3600000)).padStart(2, "0");
        const m = String(Math.floor(diff % 3600000 / 60000)).padStart(2, "0");
        const s = String(Math.floor(diff % 60000 / 1000)).padStart(2, "0");

        timer.textContent = `Next number in ${h}:${m}:${s}`;
    }, 1000);
}

/* =========================
   DARK MODE
========================= */
if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
}

function toggleTheme() {
    document.body.classList.toggle("dark-mode");
    localStorage.setItem(
        "theme",
        document.body.classList.contains("dark-mode") ? "dark" : "light"
    );
}
</script>

</body>
</html>
